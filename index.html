<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>MagicBank Academy · Aula</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* =========================
   RESET Y BASE
========================= */
* {
  box-sizing: border-box;
}

html, body {
  margin: 0;
  height: 100%;
  font-family: Arial, sans-serif;
  background: #0a1f44;
}

/* =========================
   LAYOUT GENERAL
========================= */
body {
  display: flex;
  flex-direction: column;
}

header {
  background: #0a1f44;
  color: #c9a14a;
  text-align: center;
  padding: 14px;
  font-weight: bold;
  flex-shrink: 0;
}

/* =========================
   CHAT
========================= */
#chat {
  flex: 1;
  background: #f4f6fa;
  padding: 12px;
  overflow-y: auto;
}

.msg {
  margin-bottom: 14px;
  line-height: 1.45;
}

.user {
  color: #0a1f44;
  font-weight: bold;
}

.tutor {
  color: #222;
}

/* =========================
   AVATAR ORBE
========================= */
#orb-container {
  display: flex;
  justify-content: center;
  align-items: center;
  padding: 18px;
  background: #0a1f44;
}

/* ORBE BASE */
#orb {
  width: 78px;
  height: 78px;
  border-radius: 50%;
  background: radial-gradient(circle at top, #1c3b75, #0a1f44);
  box-shadow:
    0 0 18px rgba(201,161,74,0.25),
    inset 0 0 10px rgba(255,255,255,0.05);
  cursor: pointer;
  transition: box-shadow 0.3s ease, background 0.3s ease;
  animation: breathe 4.5s ease-in-out infinite;
}

/* RESPIRACIÓN SUAVE (SILENCIO) */
@keyframes breathe {
  0%   { transform: scale(1);   box-shadow: 0 0 18px rgba(201,161,74,0.20); }
  50%  { transform: scale(1.04); box-shadow: 0 0 24px rgba(201,161,74,0.35); }
  100% { transform: scale(1);   box-shadow: 0 0 18px rgba(201,161,74,0.20); }
}

/* HABLANDO */
#orb.speaking {
  background: radial-gradient(circle at top, #ffe2a6, #c9a14a);
  box-shadow:
    0 0 36px rgba(201,161,74,0.95),
    inset 0 0 14px rgba(255,255,255,0.35);
  animation: pulse 0.9s ease-in-out infinite;
}

/* PULSO DE VOZ */
@keyframes pulse {
  0%   { transform: scale(1); }
  50%  { transform: scale(1.07); }
  100% { transform: scale(1); }
}

/* =========================
   INPUT
========================= */
footer {
  display: flex;
  gap: 8px;
  padding: 10px;
  background: #ffffff;
  border-top: 1px solid #ccc;
  flex-shrink: 0;
}

textarea {
  flex: 1;
  resize: none;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 14px;
  height: 44px;
}

button {
  border: none;
  border-radius: 8px;
  padding: 0 16px;
  font-weight: bold;
  cursor: pointer;
  background: #c9a14a;
  color: #0a1f44;
}

button:active {
  opacity: 0.85;
}
</style>
</head>

<body>

<header>
  MagicBank Academy · Aula
</header>

<div id="chat"></div>

<div id="orb-container">
  <div id="orb" title="Escuchar al tutor"></div>
</div>

<footer>
  <textarea id="input" placeholder="Escribe al tutor..."></textarea>
  <button id="send">Enviar</button>
</footer>

<script>
/* =========================
   ELEMENTOS
========================= */
const chat = document.getElementById("chat");
const input = document.getElementById("input");
const sendBtn = document.getElementById("send");
const orb = document.getElementById("orb");

/* =========================
   BACKEND
========================= */
const BACKEND_URL =
  "https://magic-bank-backend-production-713e.up.railway.app/api/magicbank/aula/texto";

/* =========================
   ESTADO DE VOZ
========================= */
let lastTutorText = "";
let speaking = false;

/* =========================
   CHAT
========================= */
function addMessage(text, cls) {
  const div = document.createElement("div");
  div.className = "msg " + cls;
  div.textContent = text;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

/* =========================
   ENVÍO DE MENSAJE
========================= */
async function sendMessage(msg) {
  addMessage("Tú: " + msg, "user");

  try {
    const res = await fetch(BACKEND_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        message: msg,
        course_id: "cocina_avanzada",
        profile: { preferred_name: "Gustavo" }
      })
    });

    const data = await res.json();
    const tutorText = data.text || data.response || "";

    if (tutorText) {
      lastTutorText = tutorText;
      addMessage("Tutor: " + tutorText, "tutor");
    } else {
      addMessage("Tutor sin respuesta.", "tutor");
    }

  } catch (e) {
    addMessage("Error de conexión con el tutor.", "tutor");
  }
}

sendBtn.onclick = () => {
  const msg = input.value.trim();
  if (!msg) return;
  input.value = "";
  sendMessage(msg);
};

/* =========================
   VOZ (BAJO DEMANDA)
========================= */
function speak(text) {
  if (!window.speechSynthesis || !text) return;

  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = "es-ES";
  utterance.rate = 0.95;
  utterance.pitch = 1.0;
  utterance.volume = 1.0;

  utterance.onstart = () => {
    speaking = true;
    orb.classList.add("speaking");
  };

  utterance.onend = () => {
    speaking = false;
    orb.classList.remove("speaking");
  };

  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utterance);
}

/* =========================
   ORBE CLICK
========================= */
orb.onclick = () => {
  if (speaking) {
    window.speechSynthesis.cancel();
    orb.classList.remove("speaking");
    speaking = false;
    return;
  }
  speak(lastTutorText);
};
</script>

</body>
</html>
